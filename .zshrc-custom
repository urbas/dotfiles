PROGRAMMING_DIR=$HOME/programming

# Nix
if [ -d $NIX_HOME_ENV ]; then
  export LOCALE_ARCHIVE_2_27="$NIX_HOME_ENV/lib/locale/locale-archive"
fi

nus-all() {
  (
    set -e
    nix-build ~/.nixpkgs $(nus-envs | xargs -n1 -I{} echo '-vA envs.{}')
    nus-envs | xargs -P8 -n1 -I{} zsh -c 'nix-env -f ~/.nixpkgs -p /nix/var/nix/profiles/{} -iA envs.{} && nix-env -p /nix/var/nix/profiles/{} --delete-generations old'
    nix-collect-garbage
    nix-store --optimise
  )
}

nus-envs() {
  nix-instantiate ~/.nixpkgs -A envs 2> /dev/null | cut -d'-' -f2 | cut -d'.' -f1
}

# Frequent directories aliases
alias n="cd $PROGRAMMING_DIR/nest"
alias p="cd $PROGRAMMING_DIR"

# General aliases
alias dotfiles="git --git-dir=$HOME/.my-dotfiles --work-tree=$HOME"
alias gaip="ga -ip"
alias c="xclip -selection clipboard"
alias v="xclip -selection clipboard -o"
alias rf="rm -rf"

function yqh() {
  if [ $# -gt 0 ]; then
    yq -y $@ | bat -l yaml
  else
    yq -y '.' | bat -l yaml
  fi
}

# Better cli
if [ -x "$(which bat)" ]; then
  alias cat="bat"
fi

export FZF_DEFAULT_COMMAND='fd --hidden --follow --exclude .git --exclude .cache'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND --type f"
export FZF_ALT_C_COMMAND="$FZF_DEFAULT_COMMAND --type d"

if [ -f $NIX_HOME_ENV/share/fzf/key-bindings.zsh ]; then
  . $NIX_HOME_ENV/share/fzf/key-bindings.zsh

  # Select and checkout a git branch
  fzf-branches-widget() {
    local selected
    setopt localoptions noglobsubst noposixbuiltins pipefail 2> /dev/null
    selected=( $(fd -t d -d 1 . ~/programming -x bash -c "git -C {} branch 2> /dev/null | sed -E 's,^\*(.*)$, \1 \o033[0;32m(current)\o033[0m,' | sed -E 's,^ ,\o033[0;34m{}\o033[0m,'" | grep -v 'HEAD detached' |
      FZF_DEFAULT_OPTS="--height ${FZF_TMUX_HEIGHT:-40%} $FZF_DEFAULT_OPTS --ansi -n2..,.. --tiebreak=index --bind=ctrl-r:toggle-sort $FZF_CTRL_R_OPTS --query=${(qqq)LBUFFER} +m" $(__fzfcmd)) )
    local ret=$?
    if [ -n "$selected" ]; then
      cd ${selected[1]}
      git checkout ${selected[2]}
      echo
    fi
    zle reset-prompt
    return $ret
  }
  zle     -N   fzf-branches-widget
  bindkey '^V' fzf-branches-widget
fi

# TODO: delete once happy with Python in Nix
# pyenv
# export PYENV_ROOT="$HOME/.pyenv"
# export PATH="$PYENV_ROOT/bin:$PATH"
# if command -v pyenv 1>/dev/null 2>&1; then
#   eval "$(pyenv init -)"
# fi

# nvm
# export NVM_DIR="$HOME/.nvm"
# [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
# [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"